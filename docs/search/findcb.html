<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The findCallback() function - Build your own text editor in Zig</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/css/code-blocks.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Build your own text editor in Zig</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-findcallback-function"><a class="header" href="#the-findcallback-function">The <code>findCallback()</code> function</a></h1>
<p>This one is big. We'll start with a stub, filled with placeholders. We reset
the highlight and we handle clean up at the start of the function, so that
later it can return at any point.</p>
<div class="code-title">Editor.zig</div>
<pre><code class="language-zig">/// Called by promptForInput() for every valid inserted character.
/// The saved view is restored when the current query isn't found, or when
/// backspace clears the query, so that the search starts from the original
/// position.
fn findCallback(e: *Editor, ca: t.PromptCbArgs) t.EditorError!void {
    // 1. variables
    // 2. restore line highlight
    // 3. clean up
    // 4. query is empty so no need to search, but restore position
    // 5. handle backspace
    // 6. find the starting line and the column offset for the search
    // 7. start the search
}
</code></pre>
<h3 id="variables"><a class="header" href="#variables">Variables</a></h3>
<p>As we did before, we have a <code>static</code> struct which will save the current state
of the search.</p>
<pre><code class="language-zig">    const static = struct {
        var found: bool = false;
        var view: t.View = .{};
        var pos: t.Pos = .{};
        var oldhl: []t.Highlight = &amp;.{};
    };
</code></pre>
<p>We also define some constants:</p>
<pre><code class="language-zig">    const empty = ca.input.items.len == 0;
    const numrows = e.buffer.rows.items.len;
</code></pre>
<h3 id="restore-line-highlight-before-incsearch-highlight"><a class="header" href="#restore-line-highlight-before-incsearch-highlight">Restore line highlight before incsearch highlight</a></h3>
<p>Before a new search attempt, we restore the underlying line highlight, so that
if the search fails, the search highlight has been cleared already.</p>
<pre><code class="language-zig">    // restore line highlight before incsearch highlight, or clean up
    if (static.oldhl.len &gt; 0) {
        @memcpy(e.rowAt(static.pos.lnr).hl, static.oldhl);
    }
</code></pre>
<h3 id="clean-up"><a class="header" href="#clean-up">Clean up</a></h3>
<p>The clean up must also be handled early. This block runs during the last
invocation of the callback, that is done for this exact purpose.</p>
<p>In this step we free the search highlight, reset our static variables and
restore the view if necessary.</p>
<pre><code class="language-zig">    // clean up
    if (ca.final) {
        e.alc.free(static.oldhl);
        static.oldhl = &amp;.{};
        if (empty or ca.key == .esc) {
            e.view = ca.saved;
        }
        if (!static.found and ca.key == .enter) {
            try e.statusMessage("No match found", .{});
        }
        static.found = false;
        return;
    }
</code></pre>
<h3 id="empty-query"><a class="header" href="#empty-query">Empty query</a></h3>
<p>This happens after we press <kbd>Backspace</kbd> and the query is now empty.
We don't cancel the search yet, but we restore the original view.
Search will be canceled if we press <kbd>Backspace</kbd> again.
We also reset <code>static.found</code> because it was true if that character we just
deleted was a match.</p>
<pre><code class="language-zig">    // Query is empty so no need to search, but restore position
    if (empty) {
        static.found = false;
        e.view = ca.saved;
        return;
    }
</code></pre>
<h3 id="handle-backspace"><a class="header" href="#handle-backspace">Handle <kbd>Backspace</kbd></a></h3>
<p>This happens when we press <kbd>Backspace</kbd>, but the query is not empty.
In this case we restore our static view, which is set later on. Note that if
the current query can't be found, this would be the same of the original view,
but what matters is that we must restore it, whatever it is.</p>
<pre><code class="language-zig">    // when pressing backspace we restore the previously saved view
    // cursor might move or not, depending on whether there is a match at
    // cursor position
    if (ca.key == .backspace or ca.key == .ctrl_h) {
        e.view = static.view;
    }
</code></pre>
<h3 id="find-the-starting-position-for-the-search"><a class="header" href="#find-the-starting-position-for-the-search">Find the starting position for the search</a></h3>
<p>We define some constants, to make the function flow more understandable.</p>
<pre><code class="language-zig">    //////////////////////////////////////////
    //   Find the starting position
    //////////////////////////////////////////

    const V = &amp;e.view;

    const prev = ca.key == .ctrl_t;
    const next = ca.key == .ctrl_g;

    // current cursor position
    var pos = t.Pos{ .lnr = V.cy, .col = V.cx };

    const eof = V.cy == numrows;
    const last_char_in_row = !eof and V.rx == e.currentRow().render.len;
    const last_row = V.cy == numrows - 1;

    // must move the cursor forward before searching when we don't want to
    // match at cursor position
    const step_fwd = next or empty or !static.found;
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning"></a>
</div>
<div>
<p>If we skip the <code>!eof</code> check when defining <code>last_char_in_row</code>, we would cause
panic when starting a search at the end of the file. This happens because
<code>e.currentRow()</code> tries to get a pointer to a line that doesn't exist. Watch out
for these things!</p>
</div>
</div>
<p>We are determining where the search must start, and that's either at cursor
position, or just after that (one character to the right). That is, we must
decide whether to accept a match at cursor position or not.</p>
<p>We want to step forward:</p>
<ul>
<li>
<p>if we press <kbd>Ctrl-G</kbd>, looking for the next match</p>
</li>
<li>
<p>if we are at the starting position, because either:</p>
<ul>
<li>we just started a search</li>
<li>query is empty</li>
<li>a match hasn't been found</li>
</ul>
</li>
</ul>
<p>In any of these cases:</p>
<pre><code class="language-zig">    if (step_fwd) {
        if (eof or (last_row and last_char_in_row)) {
            if (!opt.wrapscan) { // restart from the beginning of the file?
                return;
            }
        }
        else if (last_char_in_row) { // start searching from next line
            pos.lnr = V.cy + 1;
        }
        else { // start searching after current column
            pos.col = V.cx + 1;
            pos.lnr = V.cy;
        }
    }
</code></pre>
<h3 id="start-the-search"><a class="header" href="#start-the-search">Start the search</a></h3>
<p>Our match is an optional slice of the <code>chars.items</code> array of the Row where the
match was found. We try to find it with the appropriate functions, which we'll
define later.</p>
<pre><code class="language-zig">    //////////////////////////////////////////
    //          Start the search
    //////////////////////////////////////////

    var match: ?[]const u8 = null;

    if (!prev) {
        match = e.findForward(ca.input.items, &amp;pos);
    }
    else {
        match = e.findBackward(ca.input.items, &amp;pos);
    }

    static.found = match != null;
</code></pre>
<p>If a match is found, we update the cursor position and the static variables.</p>
<p>Since <code>match</code> is a slice of the original array, we can find the column with
pointer arithmetic, by subtracting the address of the first character of the
<code>chars.items</code> array from the address of the first character of our match.</p>
<pre><code class="language-zig">    const row = e.rowAt(pos.lnr);

    if (match) |m| {
        V.cy = pos.lnr;
        V.cx = &amp;m[0] - &amp;row.chars.items[0];

        static.view = e.view;
        static.pos = .{ .lnr = pos.lnr, .col = V.cx };
</code></pre>
<p><svg viewBox="0 0 500 130" xmlns="http://www.w3.org/2000/svg"><rect x="25" y="30" width="450" height="60" fill="#4ade80" stroke="#16a34a" stroke-width="2" opacity="0.7"/><rect x="175" y="30" width="120" height="60" fill="#f87171" stroke="#dc2626" stroke-width="2"/><text x="25" y="20" font-family="monospace" font-size="12" fill="#374151">&amp;row.chars.items[0]</text><text x="175" y="120" font-family="monospace" font-size="12" fill="#374151">&amp;m[0]</text><text x="205" y="65" font-family="Arial" font-size="14" fill="white" font-weight="bold">Match (m)</text><text x="35" y="55" font-family="Arial" font-size="14" fill="#16a34a" font-weight="bold">Row</text><text x="35" y="70" font-family="Arial" font-size="12" fill="#16a34a">(row.chars.items)</text></svg></p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p>Since we pass <code>&amp;pos</code> to the functions, we could set the column there,
but this works anyway (it's actually less trouble). Initially I wasn't using
Pos, but I'm keeping it to show an example of pointer arithmetic in Zig.
Feel free to refactor it if it suits you better.</p>
</div>
</div>
<p>Before setting the new highlight, we store a copy in <code>static.oldhl</code>. It will be
restored at the top of the callback, every time the callback is invoked.</p>
<p>Note that we are matching against <code>row.chars.items</code> (the real row), but the
highlight must match the characters in the rendered row, so we must convert our
match position first, with <code>cxToRx</code>.</p>
<pre><code class="language-zig">        // first make a copy of current highlight, to be restored later
        static.oldhl = try e.alc.realloc(static.oldhl, row.render.len);
        @memcpy(static.oldhl, row.hl);

        // apply search highlight
        const start = row.cxToRx(V.cx);
        const end = row.cxToRx(V.cx + m.len);
        @memset(row.hl[start .. end], t.Highlight.incsearch);
    }
</code></pre>
<p>If a match wasn't found, we restore the initial view (before we started
searching).</p>
<p>We must also handle the case that <code>wrapscan</code> is disabled, a match
isn't found in the current searching direction, but there was possibly a match
before, so we just remain there, and set the highlight at current position. We
need to set it because the original has been restored at the top.</p>
<p>Also here we do the same conversion, but we use the saved position.</p>
<pre><code class="language-zig">    else if (next or prev) {
        // the next match wasn't found in the searching direction
        // we still set the highlight for the current match, since the original
        // highlight has been restored at the top of the function
        // this can definitely happen with !wrapscan
        const start = row.cxToRx(static.pos.col);
        const end = row.cxToRx(static.pos.col + ca.input.items.len);
        @memset(row.hl[start .. end], t.Highlight.incsearch);
    }
    else {
        // a match wasn't found because the input couldn't be found
        // restore the original view (from before the start of the search)
        e.view = ca.saved;
    }
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../search/cb.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../search/forward.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../search/cb.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../search/forward.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
