<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scroll the view - Build your own text editor in Zig</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/css/code-blocks.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Build your own text editor in Zig</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="scroll-the-view"><a class="header" href="#scroll-the-view">Scroll the view</a></h1>
<p>There's one more thing to write, before all this begins to actually work. Until
now, movement keys would set the row (<code>View.cy</code>) and the real column (<code>View.cx</code>).
But in our <code>refreshScreen()</code> function, the escape sequence that actually moves
the cursor to the new position will need <code>View.rx</code>, that is the column in the
rendered row.</p>
<p>This value will be set in another function, <code>scroll()</code>, which will be invoked
at the top of the <code>refreshScreen()</code> function. So place the call now:</p>
<div class="code-diff-added">
<pre><code class="language-zig">/// Full refresh of the screen.
fn refreshScreen(e: *Editor) !void {
</code></pre>
</div>
<pre><code class="language-zig">    e.scroll();
</code></pre>
<p>We must define another option:</p>
<div class="code-title">option.zig</div>
<pre><code class="language-zig">/// Minimal number of screen lines to keep above and below the cursor
pub var scroll_off: u8 = 2;
</code></pre>
<p>The actual <code>scroll()</code> function has 3 purposes:</p>
<ul>
<li>adapt the view to respect the <code>scroll_off</code> option</li>
<li>set the visual column (column in the rendered row)</li>
<li>set <code>View.rowoff</code> and <code>View.coloff</code>, which control the visible part of the
buffer relatively to the first row and the first column</li>
</ul>
<div class="code-title">Editor.zig</div>
<pre><code class="language-zig">/// Scroll the view, respecting scroll_off.
fn scroll(e: *Editor) void {
    const V = &amp;e.view;
    const numrows = e.buffer.rows.items.len;

    // handle scroll_off here...

    // update rendered column here...

    // update rowoff and coloff here...
}
</code></pre>
<h3 id="the-scroll_off-option"><a class="header" href="#the-scroll_off-option">the <code>scroll_off</code> option</a></h3>
<p>This is how the Vim documentation describes it:</p>
<p><em>Minimal number of screen lines to keep above and below the cursor.
This will make some context visible around where you are working.</em></p>
<pre><code class="language-zig">    //////////////////////////////////////////
    //          scrolloff option
    //////////////////////////////////////////

    if (opt.scroll_off &gt; 0 and numrows &gt; e.screen.rows) {
        while (V.rowoff + e.screen.rows &lt; numrows
               and V.cy + opt.scroll_off &gt;= e.screen.rows + V.rowoff)
        {
            V.rowoff += 1;
        }
        while (V.rowoff &gt; 0 and V.rowoff + opt.scroll_off &gt; V.cy) {
            V.rowoff -= 1;
        }
    }
</code></pre>
<h3 id="the-rendered-column"><a class="header" href="#the-rendered-column">The rendered column</a></h3>
<pre><code class="language-zig">    //////////////////////////////////////////
    //          update rendered column
    //////////////////////////////////////////

    V.rx = 0;

    if (V.cy &lt; numrows) {
        V.rx = e.currentRow().cxToRx(V.cx);
    }
</code></pre>
<p>We just use the <code>cxToRx()</code> function, for all lines except the last one, which
is completely empty, not even a <code>\n</code> character, so we can't index it in any
way (the program would panic).</p>
<h3 id="rowoff-coloff"><a class="header" href="#rowoff-coloff"><code>rowoff</code>, <code>coloff</code></a></h3>
<p><code>rowoff</code> is the topmost visible row, <code>coloff</code> is the leftmost visible column.
While the latter is rarely positive, the former will be positive whenever we
can't see the first line of the file.</p>
<p>When the function is called, <code>cy</code> (the cursor column) can have a new value, but
<code>rowoff</code> has still the old value, so it must be updated. Same for <code>coloff</code>.</p>
<pre><code class="language-zig">    //////////////////////////////////////////
    //      update rowoff and coloff
    //////////////////////////////////////////

    // cursor has moved above the visible window
    if (V.cy &lt; V.rowoff) {
        V.rowoff = V.cy;
    }
    // cursor has moved below the visible window
    if (V.cy &gt;= V.rowoff + e.screen.rows) {
        V.rowoff = V.cy - e.screen.rows + 1;
    }
    // cursor has moved beyond the left edge of the window
    if (V.rx &lt; V.coloff) {
        V.coloff = V.rx;
    }
    // cursor has moved beyond the right edge of the window
    if (V.rx &gt;= V.coloff + e.screen.cols) {
        V.coloff = V.rx - e.screen.cols + 1;
    }
</code></pre>
<details id="admonition-casting-numbers" class="admonition admonish-tip" role="note" aria-labelledby="admonition-casting-numbers-title">
<summary class="admonition-title">
<div id="admonition-casting-numbers-title">
<p>Casting numbers</p>
</div>
<a class="admonition-anchor-link" href="#admonition-casting-numbers"></a>
</summary>
<div>
<p>When calculating a value, and we are handling <strong>unsigned</strong> integer types (like
in this case), we should avoid subtractions, unless we are <strong>absolutely</strong> sure
that the left operand is greater than the right operand.</p>
<p>Castings in Zig tend to be quite verbose, since the Zig phylosophy is to make
everything as explicit as possible, and the verbosity is also an element of the
concept of <em>friction</em> that Zig has adopted: to make safe things easy, and
unsafe things uncomfortable, even if not impossible, so that one becomes
inclined to take the safer route to the solution of a problem.</p>
<p>In this program, we don't do any casting, but we don't have to deal with
floating point numbers either.</p>
<p>To avoid castings of unsigned integers, sometimes it's enough to move the
subtracted operand to the other side of the equation, making it become
a positive operand. It's what we're doing here, even though it can make the
operation less intuitive.</p>
<p>This <a href="https://ziggit.dev/t/short-math-notation-casting-clarity-of-math-expressions/10008">thread on Ziggit
forum</a>
is an interesting read about castings.</p>
</div>
</details>
<h3 id="compile-and-run"><a class="header" href="#compile-and-run">Compile and run!</a></h3>
<p>Our text viewer is complete. You should be able to open any file and navigate
it with ease.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../viewer/cwant.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../editor/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../viewer/cwant.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../editor/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
